<!DOCTYPE html>
<html lang="it"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title th:text="${annuncio.titolo} + ' | MinervHub'">Dettaglio Annuncio</title>

    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/navbar.css}">
    <link rel="stylesheet" th:href="@{/css/annuncio.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <style>
        /* Sfondo scuro per il modale */
        .modal-overlay {
            display: none; /* Nascosto di default */
            position: fixed;
            z-index: 9999; /* Sopra a tutto */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
        }

        /* Contenuto del modale */
        .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            position: relative;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            animation: fadeIn 0.3s;
        }

        /* Bottone X di chiusura */
        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-btn:hover { color: #000; }

        /* Area di testo */
        .modal-textarea {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: vertical;
            font-family: inherit;
        }

        @keyframes fadeIn {
            from {opacity: 0; transform: translateY(-20px);}
            to {opacity: 1; transform: translateY(0);}
        }
    </style>
</head>
<body>

<header th:replace="~{fragments/navbar :: navFragment}"></header>

<div th:if="${errorMessage}" style="background:#fee2e2; color:#991b1b; padding:15px; border-radius:5px; margin-bottom:20px; text-align:center;">
    <i class="fa-solid fa-triangle-exclamation"></i> <span th:text="${errorMessage}"></span>
</div>

<div th:if="${successMessage}" class="container mt-3">
    <div class="alert alert-success alert-dismissible fade show shadow-sm" role="alert"
         style="border-radius: 15px; border: none; background-color: #d1e7dd; color: #0f5132; padding: 10px; display: flex; justify-content: center; align-items: center; gap: 15px">
        <i class="fas fa-check-circle me-2"></i>
        <span th:text="${successMessage}">Messaggio di successo</span>
    </div>
</div>

<main class="detail-container">

    <section class="announcement-main">
        <div class="announcement-image-box">
            <img src="/images/patten.png" alt="Anteprima" class="detail-img">
        </div>

        <div class="announcement-header">
            <div class="title-row">
                <h1 th:text="${annuncio.titolo}">Titolo</h1>
                <div>
                <span class="detail-price" th:if="${annuncio.tariffaOraria != null}"
                      th:text="${annuncio.tariffaOraria}"></span>
                <span class="ora">€/ora</span>
                </div>
            </div>
            <div class="meta-row">
                <span class="category-tag"><i class="fa-solid fa-graduation-cap"></i> <span th:text="${annuncio.corsoLaurea}">Corso</span></span>
                <span class="category-tag" th:if="${annuncio.esame}"><i class="fa-solid fa-book"></i> <span th:text="${annuncio.esame}">Esame</span></span>
            </div>
        </div>

        <hr class="divider">

        <div class="announcement-description">
            <h3>Descrizione</h3>
            <p th:text="${annuncio.descrizione}">Descrizione...</p>
        </div>

        <div class="list-scambio">
            <h3>Scambio</h3>

            <!-- Lista non vuota -->
            <ul th:if="${annuncio.scambio != null and !#lists.isEmpty(annuncio.scambio)}">
                <li th:each="materia : ${annuncio.scambio}"
                    th:text="${materia}">
                </li>
            </ul>

            <!-- Lista vuota -->
            <p th:if="${annuncio.scambio == null or #lists.isEmpty(annuncio.scambio)}">
                Non disponibile
            </p>
        </div>


        <div class="owner-actions" sec:authorize="isAuthenticated()"
             th:if="${annuncio.autore.email == #authentication.name}"
             style="margin-top: 2rem;">
            <a th:href="@{/annuncio/modificaAnnuncio/{id}(id=${annuncio.id})}" class="btn-primary">
                <i class="fa-solid fa-pen"></i> Modifica
            </a>
            <a th:href="@{/annuncio/eliminaAnnuncio/{id}(id=${annuncio.id})}" class="btn-primary"
               onclick="return confirm('Sei sicuro?');">
                <i class="fa-solid fa-trash"></i> Elimina
            </a>
        </div>
    </section>

    <aside class="publisher-sidebar" th:if="${sezione == 'bacheca'}">
        <div class="publisher-card">
            <h3>Pubblicato da</h3>
            <div class="publisher-info">
                <img th:src="@{'https://ui-avatars.com/api/?name=' + ${annuncio.autore.nome} + '+' + ${annuncio.autore.cognome}}" class="publisher-avatar">
                <div class="publisher-text">
                    <p class="publisher-name" th:text="${annuncio.autore.nome} + ' ' + ${annuncio.autore.cognome}"></p>
                    <small th:text="${annuncio.autore.email}"></small>
                </div>
            </div>

            <div class="contact-actions">
                <a th:href="'mailto:' + ${annuncio.autore.email}" class="btn-primary full-width" style="margin-bottom: 0.5rem;">
                    <i class="fa-regular fa-envelope"></i> Contatta via Email
                </a>

                <a sec:authorize="!isAuthenticated()" th:href="@{/login}" class="btn-secondary full-width" style="text-align:center; text-decoration:none; display:block;">
                    <i class="fa-solid fa-right-to-bracket"></i> Accedi per contattare
                </a>

                <div sec:authorize="isAuthenticated()">

                    <div th:if="${annuncio.autore.email == #authentication.name}" style="text-align:center; color:#666; font-size:0.9rem;">
                        <small>Questo è il tuo annuncio</small>
                    </div>

                    <button th:unless="${annuncio.autore.email == #authentication.name}"
                            type="button"
                            class="btn-secondary full-width"
                            id="btnApriModale">
                        <i class="fa-solid fa-paper-plane"></i> Invia Richiesta
                    </button>
                </div>
            </div>

            <div class="safety-tips">
                <i class="fa-solid fa-shield-halved"></i>
                <small>Consiglio: Scambia a mano in università.</small>
            </div>
        </div>
    </aside>

</main>

<div th:replace="~{fragments/footer :: footerFragment}"></div>

<div id="requestModal" class="modal-overlay">
    <div class="modal-content">
        <span class="close-btn" id="btnClose">&times;</span>
        <h3 style="margin-top:0;">Contatta il Tutor</h3>
        <p>Scrivi un messaggio per presentarti.</p>

        <form th:action="@{/richieste/invia}" method="post">
            <input type="hidden" name="idAnnuncio" th:value="${annuncio.id}">

            <textarea name="messaggio" class="modal-textarea" rows="4"
                      placeholder="Ciao, sono interessato alle tue lezioni..."></textarea>

            <div style="margin-top:15px; text-align:right;">
                <button type="submit" class="btn-primary">Invia Messaggio</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Aspetta che la pagina sia caricata
    document.addEventListener("DOMContentLoaded", function () {

        // Prendi gli elementi dal DOM
        var modal = document.getElementById("requestModal");
        var btn = document.getElementById("btnApriModale");
        var span = document.getElementById("btnClose");

        // Se il bottone esiste (quindi l'utente è loggato e non è il proprietario)
        if (btn) {
            btn.onclick = function() {
                modal.style.display = "flex"; // Mostra il modale
            }
        }

        // Se clicchi sulla X, chiudi
        if (span) {
            span.onclick = function() {
                modal.style.display = "none";
            }
        }

        // Se clicchi fuori dal box bianco, chiudi
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    });
</script>

</body>
</html>